# คู่มือการใช้งาน: ปักหมุดร้าน + คูปองร้านค้า

เอกสารนี้อธิบายการใช้งานฟีเจอร์ใหม่สำหรับร้านค้าและแอดมิน

## 1) ร้านค้าปักหมุดตำแหน่งร้าน

1. เข้าเมนู **บัญชี > แก้ไขข้อมูลร้าน**
2. กดปุ่ม **ปักหมุดตำแหน่งร้าน**
3. เลื่อนแผนที่ไปยังจุดร้าน แล้วกด **ยืนยันตำแหน่งนี้**
4. กด **บันทึกข้อมูล**

ผลลัพธ์:
- ระบบบันทึก `latitude` / `longitude` ใน `profiles`
- ใช้เป็นตำแหน่งอ้างอิงร้านในระบบ

---

## 2) ร้านค้าสร้างคูปองของร้านตัวเอง

1. เข้าเมนู **บัญชี > คูปองร้านค้า**
2. กรอกข้อมูลคูปอง เช่น โค้ด, ชื่อ, ประเภท, เงื่อนไขขั้นต่ำ, อายุคูปอง
3. กด **สร้างคูปอง**
4. คูปองจะไปแสดงบน **หน้าร้านของร้านนั้น** (ฝั่งลูกค้า)

หมายเหตุ:
- คูปองร้านถูกผูกกับ `merchant_id`
- ระบบกำหนดให้คูปองร้านใช้กับบริการ `food`

---

## 3) กติกาการคำนวณ GP สำหรับคูปองส่งฟรีของร้าน

เมื่อคูปองประเภท `free_delivery` ของร้านทำให้ลูกค้าไม่ต้องจ่ายค่าส่ง:

- ระบบจะเพิ่ม GP จากฝั่งร้าน **รวม 25%** ของมูลค่าอาหาร (ค่าเริ่มต้น)
- แบ่งเป็น
  - **เข้าระบบ 10%** (หรือค่าที่ตั้งไว้)
  - **ชดเชยให้คนขับ 15%**

ในโค้ดรองรับการตั้งค่าอัตราแยกผ่านคูปอง:
- `merchant_gp_charge_rate`
- `merchant_gp_system_rate`
- `merchant_gp_driver_rate`

---

## 4) แอดมินจัดการคูปองร้าน

ในหน้า Promo ของ Admin Web:
- เลือก **เจ้าของคูปอง** ได้ (ส่วนกลาง/ร้านค้า)
- ตั้งค่า GP split ของคูปองส่งฟรีได้
- เปิด/ปิด/แก้ไข/ลบคูปองได้

---

## 5) การ migrate ฐานข้อมูล

ให้รัน migration ใหม่:

- `supabase/migrations/20260304_merchant_coupon_management.sql`

migration นี้เพิ่มคอลัมน์ metadata สำหรับคูปองร้านและดัชนีที่เกี่ยวข้อง
